<?php
/**
 * Bold Payments PIGI iframe template.
 *
 * @var Bold_CheckoutPaymentBooster_Block_Payment_Form_Bold $this
 */
?>
<div id='payment_form_bold' style="display: none"></div>

<script type="text/javascript">
    /**
     * Bold order data sync class.
     */
    let Bold = Class.create({
        paymentMethodElement: document.getElementById('p_method_bold').parentNode,
        paymentContainer: document.getElementById('bold-payments-container'),
        paymentCheckbox: document.getElementById('p_method_bold'),
        isAvailable: <?php echo $this->isAvailable(); ?>,
        isFastlaneAvailable: <?php echo $this->isFastlaneAvailable(); ?>,
        /**
         * Initialize class.
         *
         * @returns {*|boolean}
         */
        initialize: async function () {
            this.showPaymentMethod();
            if (!this.isAvailable) {
                this.hidePaymentMethod();
                return;
            }
            await this.waitForBaseInstance();
            this.renderPaymentForm();
            this.subscribeToSpiEvents();
            this.waitForPaymentInitialization();
            this.waitForCheckoutInitialization();
        },
        /**
         * Wait for base instance to be initialized.
         *
         * @return {Promise<unknown>}
         */
        waitForBaseInstance: function () {
            return new Promise((resolve) => {
                const intervalId = setInterval(() => {
                    if (typeof window.bold.baseInstance !== 'undefined') {
                        clearInterval(intervalId);
                        resolve();
                    }
                }, 100);
                setTimeout(() => {
                    clearInterval(intervalId);
                    resolve();
                }, 10000);
            });
        },
        /**
         * Render payment form.
         *
         * @returns {void}
         */
        renderPaymentForm: async function () {
            const paymentInstance = await window.bold.baseInstance.getBoldPaymentsInstance();
            const boldPaymentsForm = document.getElementById('payment_form_bold');
            if (this.isFastlaneAvailable) {
                await paymentInstance.renderWalletPayments('payment_form_bold');
                if (boldPaymentsForm.getInnerHTML().trim() === '') {
                    this.hidePaymentMethod();
                }
                return;
            }
            await paymentInstance.renderPayments('payment_form_bold');
        },
        /**
         * Wait for checkout to initialize.
         *
         * @returns {void}
         */
        waitForCheckoutInitialization: function () {
            const intervalId = setInterval(() => {
                if (typeof checkout !== 'undefined' && checkout.save) {
                    this.wrapCheckoutSave();
                    clearInterval(intervalId);
                }
            }, 100);
            setTimeout(() => {
                clearInterval(intervalId);
            }, 10000);
        },
        /**
         * Wait for payment to initialize.
         *
         * @returns {void}
         */
        waitForPaymentInitialization: function () {
            const intervalId = setInterval(() => {
                if (typeof payment !== 'undefined' && payment.save) {
                    this.wrapPaymentSave();
                    clearInterval(intervalId);
                }
            }, 100);
            setTimeout(() => {
                clearInterval(intervalId);
            }, 10000);
        },
        /**
         * Wrap checkout save method to process order on Bold side first.
         *
         * @return {void}
         */
        wrapCheckoutSave: function () {
            checkout.save = checkout.save.wrap(
                function (checkoutSaveMethod) {
                    if (!this.paymentCheckbox) {
                        return checkoutSaveMethod();
                    }
                    if (!this.paymentCheckbox.checked) {
                        return checkoutSaveMethod();
                    }
                    checkout.validate();
                    if (!window.bold.paymentId) {
                        checkout.setLoadWaiting('payment', true);
                        this.tokenize();
                        return;
                    }
                    checkout.setLoadWaiting(false);
                    checkoutSaveMethod();
                }.bind(this)
            );
        },
        /**
         * Wrap payment save method to get PayPal token first.
         *
         * @return {void}
         */
        wrapPaymentSave: function () {
            payment.save = payment.save.wrap(
                function (paymentSaveMethod) {
                    if (!this.paymentCheckbox) {
                        return paymentSaveMethod();
                    }
                    if (!this.paymentCheckbox.checked) {
                        return paymentSaveMethod();
                    }
                    if (!window.bold.paymentId) {
                        checkout.setLoadWaiting('payment', true);
                        this.tokenize();
                        return;
                    }
                    checkout.setLoadWaiting(false);
                    paymentSaveMethod();
                }.bind(this)
            );
        },
        /**
         * Hide payment method section.
         */
        hidePaymentMethod: function () {
            this.paymentMethodElement.style.display = 'none';
        },
        /**
         * Show payment method section.
         */
        showPaymentMethod: function () {
            this.paymentMethodElement.style.display = 'block';
        },
        /**
         * Send tokenize action to SPI iframe.
         *
         * @return {Promise<void>}
         */
        tokenize: async function () {
            const iframeWindow = document.getElementById('spi_frame_payment_form_bold').contentWindow;
            const payload = {
                billing_address: {
                    first_name: window.bold.orderData.firstname,
                    last_name: window.bold.orderData.lastname,
                    address_line_1: window.bold.orderData.street1,
                    address_line_2: window.bold.orderData.street2,
                    province_code: window.bold.orderData.region,
                    city: window.bold.orderData.city,
                    postal_code: window.bold.orderData.postcode,
                    country_code: window.bold.orderData.country_id,
                }
            };
            iframeWindow.postMessage({actionType: 'ACTION_SPI_TOKENIZE', payload: payload}, '*');
        },
        /**
         * Subscribe to SPI iframe events.
         *
         * @returns {void}
         */
        subscribeToSpiEvents() {
            window.addEventListener('message', ({data}) => {
                const eventType = data.eventType;
                if (eventType) {
                    switch (eventType) {
                        case 'EVENT_SPI_TOKENIZED':
                            if (!data.payload.success) {
                                window.bold.paymentId = null;
                                console.error('Failed to tokenize');
                                checkout.setLoadWaiting(false);
                                return;
                            }
                            this.paymentId = data.payload?.payload?.data?.payment_id;
                            if (checkout.save) {
                                checkout.save();
                                return;
                            }
                            payment.save();
                            break;
                        case 'EVENT_SPI_TOKENIZE_FAILED':
                            window.bold.paymentId = null;
                            console.error('Failed to tokenize');
                            checkout.setLoadWaiting(false);
                            break;
                    }
                }
            });
        },
    });
    const boldInstance = new Bold();
</script>
